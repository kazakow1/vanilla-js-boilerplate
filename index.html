<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞—Ä—Ç–∞ –≤ Telegram Mini App</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const map = L.map('map').setView([55.751244, 37.618423], 13); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    let userMarker = null;
    let currentLatLng = null;

    function updatePosition(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      currentLatLng = { lat, lng };

      if (userMarker) {
        userMarker.setLatLng([lat, lng]);
      } else {
        userMarker = L.marker([lat, lng]).addTo(map).bindPopup("–í—ã –∑–¥–µ—Å—å").openPopup();
      }

      map.setView([lat, lng], 15);

      tg.MainButton.setText("üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é");
      tg.MainButton.show();
    }

    function handleError(error) {
      tg.showAlert("–û—à–∏–±–∫–∞ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏: " + error.message);
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(updatePosition, handleError, {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 5000
      });
    } else {
      tg.showAlert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é");
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
    tg.MainButton.onClick(() => {
      if (currentLatLng) {
        const data = {
          latitude: currentLatLng.lat,
          longitude: currentLatLng.lng
        };
        tg.sendData(JSON.stringify(data));

        // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        tg.MainButton.hide();
      } else {
        tg.showAlert("–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞");
      }
    });
  </script>
</body>
</html>
